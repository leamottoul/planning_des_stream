<!DOCTYPE html>
<html lang="fr" style="overflow-x: hidden;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="assets/favicon.ico" />
  <title>leatvlive.tv</title>

  <!-- Vuetify CSS -->
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.8.2/dist/vuetify.min.css" rel="stylesheet">
  
  <!-- Material Design Icons -->
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="style.css">

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  
  <!-- Vuetify JS -->
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.8.2/dist/vuetify.min.js"></script>

  <!-- Crypto JS -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore-compat.js"></script>

  <!-- Firebase Config -->
  <script src="config/var.js"></script>
  <script>
    window.CryptoJs = CryptoJS
    const firebaseConfig = JSON.parse(atob(CryptoJS.AES.decrypt(window.firebaseConfigString, atob(window.CryptoSalt)).toString(CryptoJS.enc.Utf8)))

    firebase.initializeApp(firebaseConfig)
    const db = firebase.firestore()
  </script>

  <!-- Embeding Twitch -->
  <script src="https://embed.twitch.tv/embed/v1.js"></script>

  <!-- Data classes -->
  <script src="classes/Planning.js"></script>
  <script src="classes/Setting.js"></script>
  <script src="classes/History.js"></script>
  <script src="classes/Event.js"></script>

  <!-- Assets -->
  <script src="assets/games.js"></script>
  <script src="assets/users.js"></script>
  <script src="assets/themes.js"></script>


  <!-- Custom Component -->
  <script src="components/DayCard.js"></script>
  <script src="components/LoginModal.js"></script>
  <script src="components/MagicModal.js"></script>
  <script src="components/MagicMessage.js"></script>
  <script src="components/ParametersModal.js"></script>
  <script src="components/EditEventModal.js"></script>
</head>

<body>
  <div id="app">
    <v-app style="background: transparent; height: 100%;">
      <!-- Conteneur pour le fond video -->
      <div style="position: absolute; top: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; float:inline-start" v-if="mdAndUp">
        <video src="assets/BG.webm" :style="'min-height: 120%; min-width: 120%; filter: hue-rotate('+theme.global.current.value.bgRotate+'deg) '+ (theme.global.current.value.bgInvert ? 'invert()' : '')+';'" muted autoplay loop></video>
      </div>
      <!-- Conteneur pour le fond video -->
      <div style="position: absolute; top: 0; width: 100%; height: 120%; z-index: -1; overflow: hidden; float:inline-start" v-else>
        <video src="assets/BG.webm" :style="'min-height: 120%; min-width: 120%; filter: hue-rotate('+theme.global.current.value.bgRotate+'deg) '+ (theme.global.current.value.bgInvert ? 'invert()' : '')+';'" muted autoplay loop></video>
      </div>

      <!-- conteneur pour les etoiles -->
      <div id="starsContainer" v-if="magicWordEnabled && displayStars">
        <div v-for="(star, index) in stars" :key="index" class="star" :style="'top: '+star.x+'px; left: '+star.y+'px; width: '+star.size+'px;height: '+star.size+'px; animation-delay: '+(star.x+star.y)%2+'s'"></div>
      </div>
      <v-main>
        <div class="h-100 px-8" >

          <div id="twitch-embed" :style="'margin-top: '+(twitchIsOpen ? '30px':'-765px')+'; transition: all 1s ease;'"></div>
          
          <div class="d-flex flex-row justify-center align-center" style="margin-top: -5px;">
            <v-btn class="mx-1" color="primary" icon variant="tonal" @click="twitchIsOpen=false"><v-icon>mdi-chevron-double-up</v-icon></v-btn>
          </div>
          

          <!-- Titre -->
          <h1 class="text-center my-5" style="min-height: 30px;" style="color:rgb(var(--v-theme-text))" v-if="settings">
            {{settings.title}}
          </h1>

          <!-- Bouton vers twitch -->
          <div class="d-flex flex-row justify-center align-center mb-3" style="height: 50px;">
            <v-btn class="mt-3 mx-1 rounded-lg" color="#9244FF" variant="outlined" @click="twitchIsOpen=true" height="52">
              <v-img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Twitch_Glitch_Logo_Purple.svg/512px-Twitch_Glitch_Logo_Purple.svg.png" width="32" height="32" class="mr-1"></v-img>
              <h3>Voir le Live</h3>
            </v-btn>
          </div>

          <!-- Semaine selectionnée -->
          <!-- Si même mois -->
          <h2 class="text-center" style="color:rgb(var(--v-theme-primary))" v-if="new Date(start).getMonth() == new Date(end).getMonth()">Semaine du {{new Date(start).getDate()}} au {{new Date(end).getDate()}} {{months[new Date(start).getMonth()]}}</h2>
          <!-- Si mois differents -->
          <h2 class="text-center" style="color:rgb(var(--v-theme-primary))" v-else>Semaine du {{new Date(start).getDate()}} {{months[new Date(start).getMonth()]}} au {{new Date(end).getDate()}} {{months[new Date(end).getMonth()]}}</h2>

          <!-- Planning -->
          <div class="mt-3 mx-1 d-flex flex-column flex-md-row align-center justify-center" style="height: 550px;">

            <!-- Bouton semaine changement de semaine mobile -->
            <div v-if="!mdAndUp">
              <v-btn class="mx-1" color="primary" icon variant="tonal" @click="previousWeek"><v-icon>mdi-chevron-double-left</v-icon></v-btn>
              <v-btn class="mx-1" color="primary" icon variant="tonal" @click="nextWeek"><v-icon>mdi-chevron-double-right</v-icon></v-btn>
            </div>

            <!-- Bouton semaine précédente pc -->
            <div v-if="mdAndUp">
              <v-btn class="mx-1" color="primary" icon variant="tonal" @click="previousWeek"><v-icon>mdi-chevron-double-left</v-icon></v-btn>
            </div>

            <!-- Jours de la semaine -->
            <v-col v-for="(day, index) in days" :key="index" class="h-100 ma-1 pa-0" style="min-height: 300px;">
              <div :class="(IsToday(planning[day]) ? 'today' : '') + ' d-flex flex-'+(mdAndUp?'column':'row')+' align-center justify-center h-100 w-100'">
                <template v-for="(event, index) in planning[day]">
                  <day-card :day="day" :event="event" :user="user" :amount="planning[day].length" @edit="openEditModal" class="w-100 h-100"/>
                </template>
              </div>
            </v-col>

            <!-- Bouton semaine suivante pc -->
            <div v-if="mdAndUp">
              <v-btn class="mx-1" color="primary" icon variant="tonal" @click="nextWeek"><v-icon>mdi-chevron-double-right</v-icon></v-btn>
            </div>

          </div>
          <!-- Boutons en bas de page -->
          <div :class="'d-flex flex-'+(mdAndUp? 'row' : 'column') +' justify-center align-center my-12'" style="height: 50px;">

            <!-- Boutons du mot magique -->  
            <v-btn class="mt-1 mx-1 rounded-lg" color="teal" variant="outlined" @click="magicModalIsOpen = true" height="42" v-if="!magicWordEnabled">
              <v-icon size="32">mdi-creation</v-icon>
              <h4>Tu connais le mot magique ?</h4>
            </v-btn>

            <!-- Boutons des parametres (user et admin) -->  
            <v-btn class="mt-1 mx-1 rounded-lg" color="deep-orange" variant="outlined" @click="parametersModalIsOpen = true" height="42">
              <v-icon size="32">mdi-cog</v-icon>
              <h4>Parametres</h4>
            </v-btn>
            
            <!-- Boutons de connexion/deconnexion -->  
            <v-btn class="mt-1 mx-1 rounded-lg" color="green" variant="outlined" @click="logout" height="42" v-if="IsLoggedIn">
              <v-icon size="32">mdi-lock</v-icon>
              <h4>Se deconnecter</h4>
            </v-btn>
            <v-btn class="mt-1 mx-1 rounded-lg" color="#00D26A" variant="outlined" @click="loginModalIsOpen = true" height="42" v-else>
              <v-icon size="32">mdi-lock</v-icon>
              <h4>Se connecter</h4>
            </v-btn>
          </div>
        </div>

        <!-- Baniere avertissement -->
        <v-snackbar v-model="snackbar" close-delay="false" color="primary" variant="flat" class="my-2 text-center" rounded="xl">
              <div class="d-flex flex-row justify-center align-center">
                <h1>⚠️</h1>
                <div class="mx-3">
                  <p class="text-center">
                    Le planning est à titre informatif et n'engage à rien. Celui-ci peut être modifié à tout moment et ne pas être respecté à 100%. Merci à vous
                  </p>
                </div>
                <h1>⚠️</h1>
              </div>
              <div class="w-100 mt-3 d-flex flex-row justify-center align-center">
                <v-btn color="white" variant="tonal" @click="snackbar = false" >Ok</v-btn>
              </div>
        </v-snackbar>
        
        <!-- Modal de connexion -->
        <div>
          <login-modal v-model="loginModalIsOpen" @login="login" @logout="logout"/>    
        </div>

        <!-- Modal pour le mot magique -->
        <div>    
          <magic-modal v-model="magicModalIsOpen" @magic-word="onMagicWord"/>
        </div>
        
        <!-- Modal pour les parametres -->
        <div v-if="settings">    
          <parameters-modal v-model="parametersModalIsOpen" :settings="settings" :user="user" :userIp="userIp" :history="history" :themes="themes" @update="checkForChanges"/>
        </div>

        <!-- Message de validation du mot magique -->
        <div v-if="settings">    
          <magic-message v-model="magicMessageIsOpen" :message="settings.popupMessage"/>
        </div>

        <!-- Modal pour la modification -->
        <div>    
          <edit-event-modal v-model="editEventModalIsOpen" :event="editEvent" :user="user"/>
        </div>
        

      </v-main>
    </v-app>
  </div>

  <script>
    //Declaration des fonctions de base de vue et vuetify
    const { createApp } = Vue;
    const { createVuetify, useDisplay, useTheme } = Vuetify;

    // Création de l'app principale
    const app = createApp({
      // Declaration des composant custom
      components: {
        DayCard,
        LoginModal,
        MagicModal,
        MagicMessage,
        ParametersModal,
        EditEventModal,
      },
      // initialisation de certaine fonction de vuetify
      setup() {
        const { mdAndUp } = useDisplay()
        const theme = useTheme()
        return { mdAndUp, theme, themes }
      },
      //declaration des variables reactives
      data() {
        return {
          eventUnsub: [],
          historyUnsub: [],
          settingsUnsub: [],

          userIp: null,

          snackbar: false,
          twitchIsOpen: false,

          token: null,
          settings: null,
          
          magicWordEnabled: false,
          displayStars: false,
          stars : [],

          start: null,
          end: null,

          days: ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"],
          months: ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"],
          planning: {},

          magicModalIsOpen: false,
          loginModalIsOpen: false,
          parametersModalIsOpen: false,
          editEventModalIsOpen: false,

          editEvent: null,

          magicMessageIsOpen: false,

          history: [],
        }
      },

      // fonction au chargement de la page
      async mounted() {        

        //Activate twitch player
        new Twitch.Embed("twitch-embed", {
          width: '100%',
          height: 720,
          channel: "leatvlive",
        })

        //Trigger le snackbar pour l'avertissement
        setTimeout(() => {
          this.snackbar = true
        }, 1000);

        //recuperation de l'IP de l'utilisateur
        const response = await fetch('https://api.ipify.org?format=json')
        const data = await response.json()
        this.userIp = data.ip

        //chargement et tri de l'historique de logs
        this.historyUnsub.push(History.listenAll(async (history) => {
          this.history = history
          this.history.sort( (a,b) => {
            let stringA = a.date.split("/").reverse().join("-") + "T" + a.time + ".000Z"
            let stringB = b.date.split("/").reverse().join("-") + "T" + b.time + ".000Z"
            
            let dateA = new Date(stringA).getTime()
            let dateB = new Date(stringB).getTime()

            return dateB - dateA
          })
        }))

        //initialisation des etoiles
        this.stars = this.getStars()

        //recuperation du planning
        const date = new Date()
        const day = date.getDay() || 7
        if (day != 1) {
          date.setHours(-24 * (day - 2))
        }
        date.setHours(12, 0, 0, 0)
        this.start = date.toISOString().split('T')[0]
        this.end = new Date(date.getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        
        this.GetPlanningData()

        //recuperation des parametres
        this.settingsUnsub.push(Setting.listenById('global', async (settings) => {
          this.settings = settings

          if(sessionStorage.getItem("magicWordEnabled") && sessionStorage.getItem("magicWordEnabled") == "true" && sessionStorage.getItem("lastMagicWordFound") != this.settings.magicWord) {
            this.magicWordEnabled = false
            sessionStorage.setItem("magicWordEnabled", false)
            this.checkForChanges()
          }
        }))

        let tmp_magicWordEnabled = sessionStorage.getItem("magicWordEnabled")
        if(tmp_magicWordEnabled == null) {
          sessionStorage.setItem("magicWordEnabled", false)
        }
        this.magicWordEnabled = sessionStorage.getItem("magicWordEnabled") == "true"

        //check pour l'affichage du theme et des etoiles
        this.checkForChanges()

        //check le token de connexion toutes les secondes
        setInterval(() => {
          this.checkToken()
        }, 1000)
      },

      //declaration des variables précalculées
      computed: {
        //recupere des données de l'utilisateur connecté
        user() {
          if(this.token) {
            let [username, password] = this.token.split("::").map(t => CryptoJs.AES.decrypt(t, atob(window.CryptoSalt)).toString(CryptoJs.enc.Utf8))
            let user = users.find(user => user.username == username)
            if(user) {
              return user
            }else{
              return null
            }
          }else{
            return null
          }
        },
        //indique si l'utilisateur est connecté
        IsLoggedIn() {
          return this.user != null
        },
      },

      //declaration des methodes internes
      methods: {

        //Verifie si le theme et les etoiles doivent etre affichés
        checkForChanges() {
          let tmp_theme = sessionStorage.getItem("theme")

          if(themes[tmp_theme]) {
            if(themes[tmp_theme].needMagicWord && !this.magicWordEnabled) {
              tmp_theme = "dark"
            }
          }

          if(tmp_theme) {
            this.changeTheme(tmp_theme)
          }else{
            this.changeTheme("dark")
          }

          let tmp_starsEnabled = sessionStorage.getItem("starsEnabled") == "true"

          if(tmp_starsEnabled && !this.magicWordEnabled) {
            tmp_starsEnabled = false
          }

          if(tmp_starsEnabled) {
            this.updateStarsDisplay(tmp_starsEnabled)
          }else{
            this.updateStarsDisplay(false)
          }
        },
        
        //mettre à jour le theme 
        changeTheme(value) {
          this.theme.global.name.value = value
          sessionStorage.setItem("theme", value)
        },

        //mettre à jour le l'affichage des étoiles
        updateStarsDisplay(value) {
          if(value) {
            this.displayStars = true
          }else{
            this.displayStars = false
          }
          sessionStorage.setItem("starsEnabled", value)
        },

        //generer la grilles d'etoiles
        getStars(){
          let stars = []
          let starsRow = 10
          let starsCol = 20
          for(let i = 0; i < starsRow; i++){
            for(let j = 0; j < starsCol; j++){
              let x = window.innerHeight/starsRow * i + Math.floor(Math.random() * (window.innerHeight/starsRow))
              let y = window.innerWidth/starsCol * j + Math.floor(Math.random() * (window.innerWidth/starsCol))
              let size = Math.floor(Math.random() * 4) + 2
              stars.push({
                x: x,
                y: y,
                size: size,
              })
            }
          }
          return stars
        },

        //ouvrir le modal d'edition d'un evenement
        openEditModal(event) {
          this.editEvent = event
          this.editEventModalIsOpen = true
        },

        //passer à la semaine suivante
        async nextWeek() {
          const date = new Date(this.start)
          date.setDate(date.getDate() + 7)
          this.start = date.toISOString().split('T')[0]
          this.end = new Date(date.getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        
        this.GetPlanningData()
        },

        //passer à la semaine précédente
        async previousWeek() {
          const date = new Date(this.start)
          date.setDate(date.getDate() - 7)
          this.start = date.toISOString().split('T')[0]
          this.end = new Date(date.getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        
          this.GetPlanningData()
        },

        //verifier si le mot magique est correct
        async onMagicWord(magicWordSent) {
          let trueMagicWord = this.settings.magicWord ? this.settings.magicWord : 'magic'
          if(magicWordSent == trueMagicWord) {
            this.magicWordEnabled = true
            sessionStorage.setItem("magicWordEnabled", true)
            sessionStorage.setItem("lastMagicWordFound", this.settings.magicWord)

            sessionStorage.setItem("theme", 'magic')
            sessionStorage.setItem("starsEnabled", true)

            this.checkForChanges()
            this.magicMessageIsOpen = true

            if(this.user && this.user.username && this.user.role) {
              let log = new History(null, this.user.username, this.user.role, new Date().toLocaleDateString(), new Date().toLocaleTimeString(), 'Mot magique trouvé')
              await log.save()
            }else{
              let log = new History(null, "Anonyme ("+this.userIp+")", "user", new Date().toLocaleDateString(), new Date().toLocaleTimeString(), 'Mot magique trouvé')
              await log.save()
            }

            this.settings.magicWordFound += 1
            this.settings.lastMagicWordFound += 1
            this.settings.save()
          }
        },

        //connexion de l'utilisateur
        async login(user){
          let token = CryptoJs.AES.encrypt(user.username, atob(window.CryptoSalt)).toString()
          token = token + "::"+ CryptoJs.AES.encrypt(user.password, atob(window.CryptoSalt)).toString()
          sessionStorage.setItem("token", token)
          this.checkToken()
          let log = new History(null, user.username, user.role, new Date().toLocaleDateString(), new Date().toLocaleTimeString(), 'Connexion')
          await log.save()
        },

        //deconnexion de l'utilisateur
        async logout() {
          let log = new History(null, this.user.username, this.user.role, new Date().toLocaleDateString(), new Date().toLocaleTimeString(), 'Déconnexion')
          await log.save()
          sessionStorage.removeItem("token")
          this.checkToken()
        },

        //verifier si le token de l'utilisateur est valide
        checkToken() {
          let tmp_token = sessionStorage.getItem("token")
          if(tmp_token != this.token) {
            this.token = tmp_token
          }
        },

        //recuperer le planning de la semaine
        async GetPlanningData(rawPlanningData) {
          for (const day of this.days) {
            this.planning[day] = []
          }

          for(let currentDay = 0; currentDay < 7; currentDay++) {
            let currentDate = new Date(this.start)
            currentDate.setDate(currentDate.getDate() + currentDay)

            let currentDayName = this.days[(currentDate.getDay() + 6) % 7]
            let currentDayDate = currentDate.toISOString().split('T')[0]
            
            this.eventUnsub.forEach((unsubscribe) => {
              if(typeof unsubscribe === 'function') {
                unsubscribe()
              }
            })

            this.eventUnsub.push(Event.listenByDate(currentDayDate, async (events) => {
              this.planning[currentDayName] = []
              if(events && events.length > 0) {
                events.sort((a, b) => {
                  if(a.hour == null) {
                    return 1
                  }else if(b.hour == null) {
                    return -1
                  }
                  let hoursA = a.hour.split('h')[0]
                  let minutesA = a.hour.split('h')[1]
                  let hoursB = b.hour.split('h')[0]
                  let minutesB = b.hour.split('h')[1]

                  if(hoursA == hoursB) {
                    return minutesA - minutesB
                  }else{
                    return hoursA - hoursB
                  }
                })
                for(let event of events){
                  this.planning[currentDayName].push(event)
                }
              }else{
                // Si pas d'evenement, on en cree un par defaut
                let tmpEvent =  new Event(currentDayDate + "-" + new Date().getTime(), currentDayDate, null, null, null)
                await tmpEvent.save()
              }
            }))
          }
        },

        //verifier si les evenements sont aujourd'hui
        IsToday(events){
          let today = new Date().setHours(12,0,0,0)
          today = new Date(today).toISOString().split('T')[0]
          if(!events || events.length == 0) {
            return false
          }
          for(let event of events) {
            if(event.date != today) {
              return false
            }
          }
          return true
        }
      },
      beforeDestroy() {
        // Annuler les abonnements Firestore
        for (const unsubscribe of this.eventUnsub) {
          if(typeof unsubscribe === 'function') {
            unsubscribe()
          }
        }
        for (const unsubscribe of this.historyUnsub) {
          if(typeof unsubscribe === 'function') {
            unsubscribe()
          }
        }
      },
    })


    // Initialisation de Vuetify
    const vuetify = createVuetify(
      {
        theme: {
          defaultTheme: 'dark',
          themes: themes
        },
      }
    );

    app.use(vuetify);
    app.mount('#app');
  </script>
</body>
</html>
