<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendrier Magique des Streams</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, deleteField, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBI0e7UVfPb9_HimzEsqUF24PiJjuMO6WY",
      authDomain: "planning-twitch-leatvlive.firebaseapp.com",
      projectId: "planning-twitch-leatvlive",
      storageBucket: "planning-twitch-leatvlive.firebasestorage.app",
      messagingSenderId: "975502573700",
      appId: "1:975502573700:web:a9c88741a6b476367d82d1",
      measurementId: "G-TK7SY4TDSV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const calendarContainer = document.createElement('div');
    calendarContainer.innerHTML = `
      <div class="container">
        <h1 id="month-year">‚ú® Calendrier Magique des Streams</h1>
        <div class="calendar-header">
          <button onclick="changeMonth(-1)">‚¨ÖÔ∏è Mois pr√©c√©dent</button>
          <button id="authBtn" onclick="handleAuth()">üîí Modifier le planning</button>
          <button onclick="changeMonth(1)">Mois suivant ‚û°Ô∏è</button>
        </div>
        <div class="calendar" id="calendar-days"></div>
      </div>
    `;
    document.body.appendChild(calendarContainer);

    window.editUnlocked = false;
    window.failedAttempts = 0;
    window.lockoutUntil = null;
    window.currentDate = new Date();
    window.selectedDay = null;

    const users = { "leamc": "mdp2025" };

    window.getKey = (year, month) => `${year}-${month + 1}`;

    window.loadData = async (key) => {
      const ref = doc(db, "plannings", key);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : {};
    };

    window.saveData = async (key, data) => {
      const ref = doc(db, "plannings", key);
      await setDoc(ref, data);
    };

    window.deleteDay = async () => {
      const key = getKey(currentDate.getFullYear(), currentDate.getMonth());
      const ref = doc(db, "plannings", key);
      await updateDoc(ref, { [selectedDay]: deleteField() });
      closeModal("editModal");
      createCalendar(currentDate);
    };

    window.saveEdit = async () => {
      if (selectedDay === null) return;
      const title = document.getElementById("title").value.trim();
      const type = document.getElementById("type").value;
      const hour = document.getElementById("hour").value;
      const key = getKey(currentDate.getFullYear(), currentDate.getMonth());
      const data = await loadData(key);
      data[selectedDay] = { title, type, hour };
      await saveData(key, data);
      closeModal("editModal");
      createCalendar(currentDate);
    };

    window.createCalendar = async (date) => {
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();
      const data = await loadData(getKey(year, month));
      const container = document.getElementById("calendar-days");

      container.innerHTML = "";
      document.getElementById("month-year").textContent =
        `‚ú® Calendrier Magique des Streams ‚Äì ${["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"][month]} ${year}`;

      for (let i = 1; i < (firstDay === 0 ? 7 : firstDay); i++) {
        const empty = document.createElement("div");
        empty.className = "day empty";
        container.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const div = document.createElement("div");
        div.className = "day";
        div.dataset.day = day;
        div.innerHTML = `<strong>${day}</strong>`;

        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
          div.classList.add("today");
        }

        if (data[day]) {
          const info = document.createElement("div");
          info.className = `stream-info ${data[day].type}`;
          info.innerHTML = `${data[day].title}<br><small>${data[day].type} √† ${data[day].hour}</small>`;
          div.appendChild(info);
        }

        div.onclick = () => {
          if (!editUnlocked) return;
          selectedDay = day;
          openModal('editModal');
          const d = data[day] || {};
          document.getElementById("title").value = d.title || "";
          document.getElementById("type").value = d.type || "Minecraft";
          document.getElementById("hour").value = d.hour || "20h00";
        };

        container.appendChild(div);
      }
    };

    window.changeMonth = (delta) => {
      currentDate.setMonth(currentDate.getMonth() + delta);
      createCalendar(currentDate);
    };

    window.handleAuth = () => {
      document.getElementById("authTitle").textContent = editUnlocked ? "D√©connexion" : "Connexion";
      openModal("loginModal");
    };

    window.validateLogin = () => {
      const user = document.getElementById("loginUser").value.trim();
      const pass = document.getElementById("loginPass").value.trim();

      if (users[user] && users[user] === pass) {
        closeModal("loginModal");
        editUnlocked = !editUnlocked;
        document.getElementById("authBtn").textContent = editUnlocked ? "üö™ D√©connexion" : "üîí Modifier le planning";
        alert(editUnlocked ? "üîì Acc√®s d√©bloqu√© !" : "üåô D√©connect√©e. √Ä bient√¥t L√©a !");
        failedAttempts = 0;
      } else {
        failedAttempts++;
        if (failedAttempts >= 3) {
          lockoutUntil = Date.now() + 10 * 60 * 1000;
          alert("Trop de tentatives ! R√©essaie dans 10 minutes.");
          closeModal("loginModal");
        } else {
          alert("Identifiants incorrects !");
        }
      }
    };

    window.openModal = (id) => document.getElementById(id).style.display = "flex";
    window.closeModal = (id) => document.getElementById(id).style.display = "none";

    window.onload = () => createCalendar(currentDate);
  </script>
</head>
<body>
<!-- Le contenu HTML est g√©r√© dynamiquement via JavaScript Firebase Firestore -->
<div class="modal" id="loginModal" style="display:none">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('loginModal')">‚ùå</span>
    <h2 id="authTitle">Connexion</h2>
    <input type="text" id="loginUser" placeholder="Nom d'utilisateur" />
    <input type="password" id="loginPass" placeholder="Code s√©curis√©" />
    <button onclick="validateLogin()">‚úÖ Valider</button>
  </div>
</div>
<div class="modal" id="editModal" style="display:none">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('editModal')">‚ùå</span>
    <h2>Modifier le jour</h2>
    <input type="text" id="title" placeholder="Titre du stream" />
    <select id="type">
      <option value="Minecraft">Minecraft</option>
      <option value="GTA">GTA RP</option>
      <option value="Chat">Just Chatting</option>
      <option value="Test">Test/Setup</option>
      <option value="Off">Off/Pause</option>
    </select>
    <select id="hour">
      <option value="10h00">10h00</option>
      <option value="14h30">14h30</option>
      <option value="18h00">18h00</option>
      <option value="20h00">20h00</option>
      <option value="22h00">22h00</option>
    </select>
    <button onclick="saveEdit()">üíæ Enregistrer</button>
    <button onclick="deleteDay()">üóëÔ∏è Supprimer</button>
  </div>
</div>
</body>
</html>
